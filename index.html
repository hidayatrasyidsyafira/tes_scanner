<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Absensi QR Code</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="bg-gray-100 p-4">

  <h1 class="text-2xl font-bold mb-4">Absensi QR Code</h1>
  <div id="date-time" class="mb-4 text-gray-600"></div>

  <!-- Scanner -->
  <div id="scanner" style="width: 400px; margin:auto;" class="mb-6"></div>

  <!-- Search -->
  <input type="text" id="search" placeholder="Cari siswa..." class="border p-2 mb-4 w-full">

  <!-- Rekap -->
  <div class="grid grid-cols-3 gap-4 mb-4">
    <div class="bg-green-100 p-2 rounded">Hadir: <span id="rekap-hadir">0</span></div>
    <div class="bg-yellow-100 p-2 rounded">Izin: <span id="rekap-izin">0</span></div>
    <div class="bg-red-100 p-2 rounded">Alfa: <span id="rekap-alfa">0</span></div>
  </div>

  <!-- Tabel -->
  <table class="w-full border">
    <thead>
      <tr class="bg-gray-200">
        <th class="p-2 border">NISN</th>
        <th class="p-2 border">Nama</th>
        <th class="p-2 border">Kelas</th>
        <th class="p-2 border">Status</th>
        <th class="p-2 border">Aksi</th>
      </tr>
    </thead>
    <tbody id="table-body"></tbody>
  </table>

<script>
// ================== Konfigurasi ==================
const BASE_URL = "https://script.google.com/macros/s/AKfycbzXXXXXXX/exec";

// ================== Data & State ==================
let siswaData = [];
let absensiList = [];
let currentPage = 1;
let rowsPerPage = 10;

// ================== Waktu ==================
function updateDateTime() {
  const now = new Date();
  document.getElementById("date-time").textContent = now.toLocaleString("id-ID");
}
setInterval(updateDateTime, 1000);
updateDateTime();

// ================== Scanner QR ==================
function onScanSuccess(decodedText, decodedResult) {
  html5QrcodeScanner.clear().then(_ => {
      handleScanResult(decodedText);
  }).catch(err => console.error("Gagal stop scanner:", err));
}
function onScanFailure(error) {
  console.warn(`Scan gagal: ${error}`);
}
let html5QrcodeScanner = new Html5QrcodeScanner(
  "scanner", 
  { fps: 10, qrbox: 250 }
);
html5QrcodeScanner.render(onScanSuccess, onScanFailure);

// ================== Proses Hasil Scan ==================
function handleScanResult(nisn) {
  Swal.fire({
    title: "Konfirmasi Absensi",
    text: `Apakah siswa dengan NISN ${nisn} ingin dicatat hadir?`,
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "Ya, Hadir",
    cancelButtonText: "Batal"
  }).then(result => {
    if (result.isConfirmed) {
      fetch(`${BASE_URL}?action=absen&nisn=${nisn}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            Swal.fire("Berhasil!", data.message, "success");
            fetchAbsensiData();
          } else {
            Swal.fire("Gagal!", data.message, "error");
          }
        })
        .catch(err => {
          Swal.fire("Error", "Tidak bisa terhubung ke server", "error");
          console.error(err);
        });
    } else {
      // restart scanner kalau dibatalkan
      html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    }
  });
}

// ================== Ambil Data Absensi ==================
function fetchAbsensiData() {
  fetch(`${BASE_URL}?action=getAbsensi`)
    .then(res => res.json())
    .then(data => {
      siswaData = data.siswa || [];
      absensiList = data.absensi || [];
      renderTable();
      updateRekap();
    })
    .catch(err => console.error("Gagal ambil data:", err));
}

// ================== Render Tabel ==================
function renderTable() {
  const tbody = document.getElementById("table-body");
  const searchValue = document.getElementById("search").value.toLowerCase();
  let filtered = siswaData.filter(s =>
    s.nama.toLowerCase().includes(searchValue) ||
    s.nisn.includes(searchValue) ||
    s.kelas.toLowerCase().includes(searchValue)
  );

  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const paginated = filtered.slice(start, end);

  tbody.innerHTML = "";
  paginated.forEach(s => {
    tbody.innerHTML += `
      <tr class="border-b">
        <td class="p-2 border">${s.nisn}</td>
        <td class="p-2 border">${s.nama}</td>
        <td class="p-2 border">${s.kelas}</td>
        <td class="p-2 border">${s.status || "-"}</td>
        <td class="p-2 border">
          <button onclick="viewDetail('${s.nisn}')" class="bg-blue-500 text-white px-2 py-1 rounded">Detail</button>
        </td>
      </tr>
    `;
  });
}

// ================== Update Rekap ==================
function updateRekap() {
  let hadir = absensiList.filter(a => a.status === "Hadir").length;
  let izin = absensiList.filter(a => a.status === "Izin").length;
  let alfa = absensiList.filter(a => a.status === "Alfa").length;
  document.getElementById("rekap-hadir").textContent = hadir;
  document.getElementById("rekap-izin").textContent = izin;
  document.getElementById("rekap-alfa").textContent = alfa;
}

// ================== Detail Siswa ==================
function viewDetail(nisn) {
  const siswa = siswaData.find(s => s.nisn === nisn);
  if (!siswa) return;
  Swal.fire({
    title: "Detail Siswa",
    html: `
      <p><b>NISN:</b> ${siswa.nisn}</p>
      <p><b>Nama:</b> ${siswa.nama}</p>
      <p><b>Kelas:</b> ${siswa.kelas}</p>
      <p><b>Status:</b> ${siswa.status || "-"}</p>
    `
  });
}

// ================== Inisialisasi ==================
fetchAbsensiData();
document.getElementById("search").addEventListener("input", renderTable);
</script>

</body>
</html>
